{
    "componentChunkName": "component---src-templates-md-blog-post-js",
    "path": "/posts/2023-06-05-justctf-2023-multi-auth-writeup",
    "result": {"data":{"markdownRemark":{"html":"<p>This was a fun crypto challenge from justCTF 2023 which involved subtle implementation bugs in the usage of crypto libraries in Python, Golang and NodeJS. I worked on this with a teammate and we got first blood :)</p>\n<h1>Multi Auth</h1>\n<blockquote>\n<p>Every crypto code may have bugs, so we have made a multi-authentication system diversifying across algorithms and languages.</p>\n<p><code>nc multiauth.nc.jctf.pro 1337</code></p>\n<p>Author: gros</p>\n</blockquote>\n<p><code>main.rs</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">extern</span> <span class=\"token keyword\">crate</span> <span class=\"token module-declaration namespace\">core</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">use</span> <span class=\"token namespace\">tokio<span class=\"token punctuation\">::</span>io<span class=\"token punctuation\">::</span></span><span class=\"token punctuation\">{</span><span class=\"token class-name\">BufReader</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">AsyncBufReadExt</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Lines</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token namespace\">tokio<span class=\"token punctuation\">::</span>process<span class=\"token punctuation\">::</span></span><span class=\"token punctuation\">{</span><span class=\"token class-name\">Command</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Child</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ChildStdout</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ChildStdin</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token namespace\">tokio<span class=\"token punctuation\">::</span>io<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">AsyncWriteExt</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token namespace\">std<span class=\"token punctuation\">::</span>process<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">Stdio</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token namespace\">std<span class=\"token punctuation\">::</span>io<span class=\"token punctuation\">::</span></span><span class=\"token punctuation\">{</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">BufRead</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ErrorKind</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token namespace\">serde<span class=\"token punctuation\">::</span></span><span class=\"token punctuation\">{</span><span class=\"token class-name\">Deserialize</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Serialize</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token namespace\">serde_with<span class=\"token punctuation\">::</span>base64<span class=\"token punctuation\">::</span></span><span class=\"token punctuation\">{</span><span class=\"token class-name\">Base64</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token namespace\">serde_with<span class=\"token punctuation\">::</span></span>serde_as<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token namespace\">std<span class=\"token punctuation\">::</span>io<span class=\"token punctuation\">::</span></span><span class=\"token punctuation\">{</span><span class=\"token class-name\">Error</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Write</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token namespace\">std<span class=\"token punctuation\">::</span></span>fs<span class=\"token punctuation\">;</span>\n\n\n<span class=\"token keyword\">struct</span> <span class=\"token type-definition class-name\">Authenticator</span> <span class=\"token punctuation\">{</span>\n    process<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Child</span><span class=\"token punctuation\">,</span>\n    stdin<span class=\"token punctuation\">:</span> <span class=\"token class-name\">ChildStdin</span><span class=\"token punctuation\">,</span>\n    reader<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Lines</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">BufReader</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">ChildStdout</span><span class=\"token operator\">>></span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">impl</span> <span class=\"token class-name\">Authenticator</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">async</span> <span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">call</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token keyword\">mut</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> rpc<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span><span class=\"token constant\">RPC</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> <span class=\"token class-name\">Result</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Vec</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">u8</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Error</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>stdin<span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token namespace\">serde_json<span class=\"token punctuation\">::</span></span><span class=\"token function\">to_string</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>rpc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">as_ref</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">await</span><span class=\"token operator\">?</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> resp_str <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>reader<span class=\"token punctuation\">.</span><span class=\"token function\">next_line</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">await</span><span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">let</span> resp<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RPCResp</span> <span class=\"token operator\">=</span> <span class=\"token namespace\">serde_json<span class=\"token punctuation\">::</span></span><span class=\"token function\">from_str</span><span class=\"token punctuation\">(</span>resp_str<span class=\"token punctuation\">.</span><span class=\"token function\">as_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">?</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> resp<span class=\"token punctuation\">.</span>success <span class=\"token operator\">==</span> <span class=\"token boolean\">false</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token class-name\">Err</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Error</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ErrorKind</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">Other</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"unsuccessful\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">match</span> resp<span class=\"token punctuation\">.</span>signature <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">Some</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token class-name\">Ok</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token class-name\">None</span> <span class=\"token operator\">=></span> <span class=\"token class-name\">Err</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Error</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ErrorKind</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">Other</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"empty signature\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">make_child</span><span class=\"token punctuation\">(</span>cmd<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span><span class=\"token keyword\">str</span><span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span><span class=\"token punctuation\">[</span><span class=\"token operator\">&amp;</span><span class=\"token keyword\">str</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> expected_hello<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span><span class=\"token keyword\">str</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> <span class=\"token class-name\">Authenticator</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> <span class=\"token keyword\">mut</span> cmd <span class=\"token operator\">=</span> <span class=\"token class-name\">Command</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span>cmd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    cmd<span class=\"token punctuation\">.</span><span class=\"token function\">stdout</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Stdio</span><span class=\"token punctuation\">::</span><span class=\"token function\">piped</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    cmd<span class=\"token punctuation\">.</span><span class=\"token function\">stdin</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Stdio</span><span class=\"token punctuation\">::</span><span class=\"token function\">piped</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">let</span> <span class=\"token keyword\">mut</span> cmd_process <span class=\"token operator\">=</span> cmd<span class=\"token punctuation\">.</span><span class=\"token function\">args</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">spawn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">expect</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"failed to spawn command\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> cmd_process_stdout <span class=\"token operator\">=</span> cmd_process<span class=\"token punctuation\">.</span>stdout<span class=\"token punctuation\">.</span><span class=\"token function\">take</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">expect</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"child did not have a handle to stdout\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> cmd_process_stdin <span class=\"token operator\">=</span> cmd_process<span class=\"token punctuation\">.</span>stdin<span class=\"token punctuation\">.</span><span class=\"token function\">take</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">expect</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"child did not have a handle to stdin\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">let</span> <span class=\"token keyword\">mut</span> cmd_process_reader <span class=\"token operator\">=</span> <span class=\"token class-name\">BufReader</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span>cmd_process_stdout<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">lines</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> hello <span class=\"token operator\">=</span> cmd_process_reader<span class=\"token punctuation\">.</span><span class=\"token function\">next_line</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">await</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token macro property\">assert_eq!</span><span class=\"token punctuation\">(</span>hello<span class=\"token punctuation\">,</span> expected_hello<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token class-name\">Authenticator</span><span class=\"token punctuation\">{</span>process<span class=\"token punctuation\">:</span> cmd_process<span class=\"token punctuation\">,</span> stdin<span class=\"token punctuation\">:</span> cmd_process_stdin<span class=\"token punctuation\">,</span> reader<span class=\"token punctuation\">:</span> cmd_process_reader<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token attribute attr-name\">#[serde_as]</span>\n<span class=\"token attribute attr-name\">#[derive(Serialize, Deserialize)]</span>\n<span class=\"token keyword\">struct</span> <span class=\"token type-definition class-name\">RPC</span> <span class=\"token punctuation\">{</span>\n    method<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span>\n    <span class=\"token attribute attr-name\">#[serde_as(as = <span class=\"token string\">\"Base64\"</span>)]</span>\n    message<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Vec</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">u8</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n    signatures<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Option</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">RPCSignature</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token attribute attr-name\">#[serde_as]</span>\n<span class=\"token attribute attr-name\">#[derive(Serialize, Deserialize, Default)]</span>\n<span class=\"token keyword\">struct</span> <span class=\"token type-definition class-name\">RPCSignature</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token attribute attr-name\">#[serde_as(as = <span class=\"token string\">\"Base64\"</span>)]</span>\n    ecdsa<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Vec</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">u8</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n    <span class=\"token attribute attr-name\">#[serde_as(as = <span class=\"token string\">\"Base64\"</span>)]</span>\n    hmac<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Vec</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">u8</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n    <span class=\"token attribute attr-name\">#[serde_as(as = <span class=\"token string\">\"Base64\"</span>)]</span>\n    aes<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Vec</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">u8</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token attribute attr-name\">#[serde_as]</span>\n<span class=\"token attribute attr-name\">#[derive(Serialize, Deserialize)]</span>\n<span class=\"token keyword\">struct</span> <span class=\"token type-definition class-name\">RPCResp</span> <span class=\"token punctuation\">{</span>\n    success<span class=\"token punctuation\">:</span> <span class=\"token keyword\">bool</span><span class=\"token punctuation\">,</span>\n    <span class=\"token attribute attr-name\">#[serde_as(as = <span class=\"token string\">\"Option&lt;Base64>\"</span>)]</span>\n    signature<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Option</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Vec</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">u8</span><span class=\"token operator\">>></span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token constant\">FORBIDDEN</span><span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span><span class=\"token keyword\">str</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"We the people, in order to get points, are kindly asking for flag\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">MAX_LEN</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">usize</span> <span class=\"token operator\">=</span> <span class=\"token number\">1337</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">POLYNOMIAL_BOUND</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">u16</span> <span class=\"token operator\">=</span> <span class=\"token number\">512</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">NOPE</span><span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span><span class=\"token keyword\">str</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"nope\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">OK</span><span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span><span class=\"token keyword\">str</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"ok\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token attribute attr-name\">#[tokio::main]</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> <span class=\"token class-name\">Result</span><span class=\"token operator\">&lt;</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Box</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">dyn</span> <span class=\"token namespace\">std<span class=\"token punctuation\">::</span>error<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">Error</span><span class=\"token operator\">>></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Multi authenticator started\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> cwd <span class=\"token operator\">=</span> <span class=\"token string\">\"/jailed\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> <span class=\"token keyword\">mut</span> hmac_auth <span class=\"token operator\">=</span> <span class=\"token function\">make_child</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"python3\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>cwd<span class=\"token punctuation\">,</span> <span class=\"token string\">\"index.py\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">as_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"HMAC authenticator started\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">await</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> <span class=\"token keyword\">mut</span> ecdsa_auth <span class=\"token operator\">=</span> <span class=\"token function\">make_child</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>cwd<span class=\"token punctuation\">,</span> <span class=\"token string\">\"indexgo\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">as_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"ECDSA authenticator started\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">await</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> <span class=\"token keyword\">mut</span> aes_auth <span class=\"token operator\">=</span> <span class=\"token function\">make_child</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"node\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>cwd<span class=\"token punctuation\">,</span> <span class=\"token string\">\"index.js\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">as_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"AES authenticator started\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">await</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> flag <span class=\"token operator\">=</span> <span class=\"token namespace\">fs<span class=\"token punctuation\">::</span></span><span class=\"token function\">read_to_string</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>cwd<span class=\"token punctuation\">,</span> <span class=\"token string\">\"flag\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">as_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">expect</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Can read flag\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">let</span> <span class=\"token keyword\">mut</span> counter<span class=\"token punctuation\">:</span> <span class=\"token keyword\">u16</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> stdin <span class=\"token operator\">=</span> <span class=\"token namespace\">io<span class=\"token punctuation\">::</span></span><span class=\"token function\">stdin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span> line <span class=\"token keyword\">in</span> stdin<span class=\"token punctuation\">.</span><span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">lines</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> counter <span class=\"token operator\">>=</span> <span class=\"token constant\">POLYNOMIAL_BOUND</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        counter <span class=\"token operator\">+=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">let</span> input <span class=\"token operator\">=</span> line<span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> <span class=\"token keyword\">mut</span> rpc<span class=\"token punctuation\">:</span> <span class=\"token constant\">RPC</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">match</span> <span class=\"token namespace\">serde_json<span class=\"token punctuation\">::</span></span><span class=\"token function\">from_str</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">.</span><span class=\"token function\">as_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">Ok</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> x<span class=\"token punctuation\">,</span>\n            <span class=\"token class-name\">Err</span><span class=\"token punctuation\">(</span>_<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n                <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"{}\"</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NOPE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">continue</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">if</span> rpc<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">.</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token constant\">MAX_LEN</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"{}\"</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NOPE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">let</span> <span class=\"token keyword\">mut</span> is_forbidden <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> rpc<span class=\"token punctuation\">.</span>message <span class=\"token operator\">==</span> <span class=\"token constant\">FORBIDDEN</span><span class=\"token punctuation\">.</span><span class=\"token function\">as_bytes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            is_forbidden <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">if</span> rpc<span class=\"token punctuation\">.</span>method <span class=\"token operator\">==</span> <span class=\"token string\">\"backdoor\"</span> <span class=\"token punctuation\">{</span>\n            rpc<span class=\"token punctuation\">.</span>method <span class=\"token operator\">=</span> <span class=\"token string\">\"auth\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">to_string</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">let</span> aes_signature <span class=\"token operator\">=</span> aes_auth<span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>rpc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">await</span><span class=\"token operator\">?</span><span class=\"token punctuation\">;</span>\n            <span class=\"token namespace\">io<span class=\"token punctuation\">::</span></span><span class=\"token function\">stdout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>aes_signature<span class=\"token punctuation\">[</span><span class=\"token punctuation\">..</span><span class=\"token number\">15</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token operator\">?</span><span class=\"token punctuation\">;</span>\n            <span class=\"token namespace\">io<span class=\"token punctuation\">::</span></span><span class=\"token function\">stdout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">flush</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">?</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> rpc<span class=\"token punctuation\">.</span>method <span class=\"token operator\">==</span> <span class=\"token string\">\"auth\"</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token operator\">!</span>rpc<span class=\"token punctuation\">.</span>signatures<span class=\"token punctuation\">.</span><span class=\"token function\">is_none</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"{}\"</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NOPE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token keyword\">if</span> is_forbidden <span class=\"token punctuation\">{</span>\n                <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"{}\"</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NOPE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token keyword\">let</span> <span class=\"token keyword\">mut</span> signature<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RPCSignature</span> <span class=\"token operator\">=</span> <span class=\"token class-name\">RPCSignature</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">..</span><span class=\"token class-name\">Default</span><span class=\"token punctuation\">::</span><span class=\"token function\">default</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">let</span> hmac_signature <span class=\"token operator\">=</span> hmac_auth<span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>rpc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">await</span><span class=\"token operator\">?</span><span class=\"token punctuation\">;</span>\n            rpc<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token keyword\">mut</span> hmac_signature<span class=\"token punctuation\">.</span><span class=\"token function\">to_vec</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            signature<span class=\"token punctuation\">.</span>hmac <span class=\"token operator\">=</span> hmac_signature<span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">let</span> ecdsa_signature <span class=\"token operator\">=</span> ecdsa_auth<span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>rpc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">await</span><span class=\"token operator\">?</span><span class=\"token punctuation\">;</span>\n            rpc<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token keyword\">mut</span> ecdsa_signature<span class=\"token punctuation\">.</span><span class=\"token function\">to_vec</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            signature<span class=\"token punctuation\">.</span>ecdsa <span class=\"token operator\">=</span> ecdsa_signature<span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">let</span> aes_signature <span class=\"token operator\">=</span> aes_auth<span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>rpc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">await</span><span class=\"token operator\">?</span><span class=\"token punctuation\">;</span>\n            signature<span class=\"token punctuation\">.</span>aes <span class=\"token operator\">=</span> aes_signature<span class=\"token punctuation\">;</span>\n\n            <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"{}\"</span><span class=\"token punctuation\">,</span> <span class=\"token namespace\">serde_json<span class=\"token punctuation\">::</span></span><span class=\"token function\">to_string</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>signature<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            rpc<span class=\"token punctuation\">.</span>method <span class=\"token operator\">=</span> <span class=\"token string\">\"verify\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">to_string</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">let</span> sigs <span class=\"token operator\">=</span> <span class=\"token keyword\">match</span> <span class=\"token operator\">&amp;</span>rpc<span class=\"token punctuation\">.</span>signatures <span class=\"token punctuation\">{</span>\n                <span class=\"token class-name\">Some</span><span class=\"token punctuation\">(</span>sigs<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">if</span> sigs<span class=\"token punctuation\">.</span>ecdsa<span class=\"token punctuation\">.</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> sigs<span class=\"token punctuation\">.</span>hmac<span class=\"token punctuation\">.</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> sigs<span class=\"token punctuation\">.</span>aes<span class=\"token punctuation\">.</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"{}\"</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NOPE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                        <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token punctuation\">}</span>\n                    sigs\n                <span class=\"token punctuation\">}</span>\n                <span class=\"token class-name\">None</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"{}\"</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NOPE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">let</span> msg_copy <span class=\"token operator\">=</span> rpc<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">;</span>\n\n            rpc<span class=\"token punctuation\">.</span>message <span class=\"token operator\">=</span> msg_copy<span class=\"token punctuation\">.</span><span class=\"token function\">to_vec</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            rpc<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token keyword\">mut</span> sigs<span class=\"token punctuation\">.</span>hmac<span class=\"token punctuation\">.</span><span class=\"token function\">to_vec</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            rpc<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token keyword\">mut</span> sigs<span class=\"token punctuation\">.</span>ecdsa<span class=\"token punctuation\">.</span><span class=\"token function\">to_vec</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> <span class=\"token class-name\">Err</span><span class=\"token punctuation\">(</span>_<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> aes_auth<span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>rpc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">await</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"{}\"</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NOPE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n            rpc<span class=\"token punctuation\">.</span>message <span class=\"token operator\">=</span> msg_copy<span class=\"token punctuation\">.</span><span class=\"token function\">to_vec</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            rpc<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token keyword\">mut</span> sigs<span class=\"token punctuation\">.</span>hmac<span class=\"token punctuation\">.</span><span class=\"token function\">to_vec</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> <span class=\"token class-name\">Err</span><span class=\"token punctuation\">(</span>_<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> ecdsa_auth<span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>rpc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">await</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"{}\"</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NOPE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n            rpc<span class=\"token punctuation\">.</span>message <span class=\"token operator\">=</span> msg_copy<span class=\"token punctuation\">.</span><span class=\"token function\">to_vec</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> <span class=\"token class-name\">Err</span><span class=\"token punctuation\">(</span>_<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> hmac_auth<span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>rpc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">await</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"{}\"</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NOPE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token keyword\">if</span> is_forbidden <span class=\"token punctuation\">{</span>\n                <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"{}\"</span><span class=\"token punctuation\">,</span> flag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"{}\"</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">OK</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token function\">drop</span><span class=\"token punctuation\">(</span>hmac_auth<span class=\"token punctuation\">.</span>stdin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">drop</span><span class=\"token punctuation\">(</span>ecdsa_auth<span class=\"token punctuation\">.</span>stdin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">drop</span><span class=\"token punctuation\">(</span>aes_auth<span class=\"token punctuation\">.</span>stdin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    hmac_auth<span class=\"token punctuation\">.</span>process<span class=\"token punctuation\">.</span><span class=\"token function\">wait</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">await</span><span class=\"token operator\">?</span><span class=\"token punctuation\">;</span>\n    ecdsa_auth<span class=\"token punctuation\">.</span>process<span class=\"token punctuation\">.</span><span class=\"token function\">wait</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">await</span><span class=\"token operator\">?</span><span class=\"token punctuation\">;</span>\n    aes_auth<span class=\"token punctuation\">.</span>process<span class=\"token punctuation\">.</span><span class=\"token function\">wait</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">await</span><span class=\"token operator\">?</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">Ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code>index.py</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"py\"><pre class=\"language-py\"><code class=\"language-py\"><span class=\"token comment\">#!/usr/bin/env python</span>\n<span class=\"token comment\"># -*- coding: utf-8 -*-</span>\n\n<span class=\"token keyword\">import</span> sys\n<span class=\"token keyword\">import</span> os\n<span class=\"token keyword\">import</span> json\n<span class=\"token keyword\">import</span> hmac\n<span class=\"token keyword\">from</span> hashlib <span class=\"token keyword\">import</span> sha256\n<span class=\"token keyword\">from</span> base64 <span class=\"token keyword\">import</span> b64decode<span class=\"token punctuation\">,</span> b64encode\n<span class=\"token keyword\">import</span> binascii\n\n\nFAILURE <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"success\"</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"signature\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">}</span>\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">verify</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> msg<span class=\"token punctuation\">,</span> sig<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> hmac<span class=\"token punctuation\">.</span>compare_digest<span class=\"token punctuation\">(</span>sig<span class=\"token punctuation\">,</span> auth<span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">auth</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> hmac<span class=\"token punctuation\">.</span>new<span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> sha256<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>digest<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"HMAC authenticator started\"</span><span class=\"token punctuation\">,</span> flush<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span>\n\n    key <span class=\"token operator\">=</span> os<span class=\"token punctuation\">.</span>urandom<span class=\"token punctuation\">(</span><span class=\"token number\">32</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">for</span> line <span class=\"token keyword\">in</span> sys<span class=\"token punctuation\">.</span>stdin<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span>\n            rpc <span class=\"token operator\">=</span> json<span class=\"token punctuation\">.</span>loads<span class=\"token punctuation\">(</span>line<span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> <span class=\"token builtin\">isinstance</span><span class=\"token punctuation\">(</span>rpc<span class=\"token punctuation\">,</span> <span class=\"token builtin\">dict</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">or</span> <span class=\"token string\">\"message\"</span> <span class=\"token keyword\">not</span> <span class=\"token keyword\">in</span> rpc <span class=\"token keyword\">or</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>rpc<span class=\"token punctuation\">[</span><span class=\"token string\">\"message\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span>\n                <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>FAILURE<span class=\"token punctuation\">,</span> flush<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span>\n                <span class=\"token keyword\">continue</span>\n\n            msg <span class=\"token operator\">=</span> b64decode<span class=\"token punctuation\">(</span>rpc<span class=\"token punctuation\">[</span><span class=\"token string\">\"message\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n            retval <span class=\"token operator\">=</span> <span class=\"token boolean\">None</span>\n\n            <span class=\"token keyword\">if</span> rpc<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">\"method\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token string\">\"auth\"</span><span class=\"token punctuation\">:</span>    \n                signature <span class=\"token operator\">=</span> auth<span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> msg<span class=\"token punctuation\">)</span>\n                retval <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"success\"</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"signature\"</span><span class=\"token punctuation\">:</span> b64encode<span class=\"token punctuation\">(</span>signature<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span>\n\n            <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n                sig <span class=\"token operator\">=</span> rpc<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">\"signatures\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">\"hmac\"</span><span class=\"token punctuation\">)</span>\n                <span class=\"token keyword\">if</span> sig <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span> <span class=\"token keyword\">or</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>sig<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span>\n                    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>FAILURE<span class=\"token punctuation\">,</span> flush<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token keyword\">continue</span>\n                retval <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"success\"</span><span class=\"token punctuation\">:</span> verify<span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> msg<span class=\"token punctuation\">,</span> b64decode<span class=\"token punctuation\">(</span>sig<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"signature\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">}</span>\n\n            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">.</span>dumps<span class=\"token punctuation\">(</span>retval<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> flush<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">except</span> Exception <span class=\"token keyword\">as</span> e<span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>FAILURE<span class=\"token punctuation\">,</span> flush<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">\"__main__\"</span><span class=\"token punctuation\">:</span>\n    main<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><code>index.go</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">package</span> main\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"bufio\"</span>\n    <span class=\"token string\">\"crypto/ecdsa\"</span>\n    <span class=\"token string\">\"crypto/elliptic\"</span>\n    <span class=\"token string\">\"crypto/rand\"</span>\n    <span class=\"token string\">\"encoding/json\"</span>\n    <span class=\"token string\">\"fmt\"</span>\n    <span class=\"token string\">\"io\"</span>\n    <span class=\"token string\">\"os\"</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">type</span> RPC <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">{</span>\n    Method     <span class=\"token builtin\">string</span>        <span class=\"token string\">`json:\"method\"`</span>\n    Message    <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">byte</span>        <span class=\"token string\">`json:\"message\"`</span>\n    Signatures <span class=\"token operator\">*</span>RPCSignature <span class=\"token string\">`json:\"signatures\"`</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">type</span> RPCSignature <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">{</span>\n    Ecdsa <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">byte</span> <span class=\"token string\">`json:\"ecdsa\"`</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">type</span> RPCResp <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">{</span>\n    Success   <span class=\"token builtin\">bool</span>   <span class=\"token string\">`json:\"success\"`</span>\n    Signature <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">byte</span> <span class=\"token string\">`json:\"signature\"`</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> failure <span class=\"token operator\">=</span> <span class=\"token string\">`{\"success\": false, \"signature\": \"\"}`</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>r <span class=\"token operator\">*</span>RPC<span class=\"token punctuation\">)</span> <span class=\"token function\">Execute</span><span class=\"token punctuation\">(</span>privateKey <span class=\"token operator\">*</span>ecdsa<span class=\"token punctuation\">.</span>PrivateKey<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">byte</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> r<span class=\"token punctuation\">.</span>Method <span class=\"token operator\">==</span> <span class=\"token string\">\"auth\"</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> signature<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> ecdsa<span class=\"token punctuation\">.</span><span class=\"token function\">SignASN1</span><span class=\"token punctuation\">(</span>rand<span class=\"token punctuation\">.</span>Reader<span class=\"token punctuation\">,</span> privateKey<span class=\"token punctuation\">,</span> r<span class=\"token punctuation\">.</span>Message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> err <span class=\"token operator\">==</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> resp<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> json<span class=\"token punctuation\">.</span><span class=\"token function\">Marshal</span><span class=\"token punctuation\">(</span>RPCResp<span class=\"token punctuation\">{</span>\n                Success<span class=\"token punctuation\">:</span>   <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n                Signature<span class=\"token punctuation\">:</span> signature<span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> err <span class=\"token operator\">==</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span> resp\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> r<span class=\"token punctuation\">.</span>Signatures <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">len</span><span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">.</span>Signatures<span class=\"token punctuation\">.</span>Ecdsa<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> ecdsa<span class=\"token punctuation\">.</span><span class=\"token function\">VerifyASN1</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>privateKey<span class=\"token punctuation\">.</span>PublicKey<span class=\"token punctuation\">,</span> r<span class=\"token punctuation\">.</span>Message<span class=\"token punctuation\">,</span> r<span class=\"token punctuation\">.</span>Signatures<span class=\"token punctuation\">.</span>Ecdsa<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> resp<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> json<span class=\"token punctuation\">.</span><span class=\"token function\">Marshal</span><span class=\"token punctuation\">(</span>RPCResp<span class=\"token punctuation\">{</span>\n                Success<span class=\"token punctuation\">:</span>   <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n                Signature<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token function\">byte</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> err <span class=\"token operator\">==</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span> resp\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token function\">byte</span><span class=\"token punctuation\">(</span>failure<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ECDSA authenticator started\"</span><span class=\"token punctuation\">)</span>\n\n    privateKey<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> ecdsa<span class=\"token punctuation\">.</span><span class=\"token function\">GenerateKey</span><span class=\"token punctuation\">(</span>elliptic<span class=\"token punctuation\">.</span><span class=\"token function\">P521</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> rand<span class=\"token punctuation\">.</span>Reader<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">panic</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    rdr <span class=\"token operator\">:=</span> bufio<span class=\"token punctuation\">.</span><span class=\"token function\">NewReader</span><span class=\"token punctuation\">(</span>os<span class=\"token punctuation\">.</span>Stdin<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">switch</span> line<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> rdr<span class=\"token punctuation\">.</span><span class=\"token function\">ReadString</span><span class=\"token punctuation\">(</span><span class=\"token string\">'\\n'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> err <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">var</span> rpc RPC\n            <span class=\"token keyword\">if</span> err <span class=\"token operator\">:=</span> json<span class=\"token punctuation\">.</span><span class=\"token function\">Unmarshal</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token function\">byte</span><span class=\"token punctuation\">(</span>line<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>rpc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n                fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>failure<span class=\"token punctuation\">)</span>\n                <span class=\"token keyword\">continue</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">if</span> <span class=\"token function\">len</span><span class=\"token punctuation\">(</span>rpc<span class=\"token punctuation\">.</span>Message<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">{</span>\n                fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>failure<span class=\"token punctuation\">)</span>\n                <span class=\"token keyword\">continue</span>\n            <span class=\"token punctuation\">}</span>\n\n            fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token function\">string</span><span class=\"token punctuation\">(</span>rpc<span class=\"token punctuation\">.</span><span class=\"token function\">Execute</span><span class=\"token punctuation\">(</span>privateKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">case</span> io<span class=\"token punctuation\">.</span>EOF<span class=\"token punctuation\">:</span>\n            os<span class=\"token punctuation\">.</span><span class=\"token function\">Exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span>\n            os<span class=\"token punctuation\">.</span><span class=\"token function\">Exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code>index.js</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> crypto <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'crypto'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> readline <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'readline'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">auth</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">key<span class=\"token punctuation\">,</span> msg</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    msg <span class=\"token operator\">=</span> Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">,</span> <span class=\"token string\">'base64'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> nonce <span class=\"token operator\">=</span> crypto<span class=\"token punctuation\">.</span><span class=\"token function\">randomBytes</span><span class=\"token punctuation\">(</span><span class=\"token number\">12</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> cipher <span class=\"token operator\">=</span> crypto<span class=\"token punctuation\">.</span><span class=\"token function\">createCipheriv</span><span class=\"token punctuation\">(</span><span class=\"token string\">'aes-256-gcm'</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> nonce<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    cipher<span class=\"token punctuation\">.</span><span class=\"token function\">setAAD</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    cipher<span class=\"token punctuation\">.</span><span class=\"token function\">final</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> tag <span class=\"token operator\">=</span> cipher<span class=\"token punctuation\">.</span><span class=\"token function\">getAuthTag</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"success\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"signature\"</span><span class=\"token operator\">:</span> Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">concat</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>nonce<span class=\"token punctuation\">,</span> tag<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token string\">'base64'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">verify</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">key<span class=\"token punctuation\">,</span> msg<span class=\"token punctuation\">,</span> sig</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    msg <span class=\"token operator\">=</span> Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">,</span> <span class=\"token string\">'base64'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> ivtag <span class=\"token operator\">=</span> Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>sig<span class=\"token punctuation\">,</span> <span class=\"token string\">'base64'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> nonce <span class=\"token operator\">=</span> ivtag<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">12</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> tag <span class=\"token operator\">=</span> ivtag<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span><span class=\"token number\">12</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> decipher <span class=\"token operator\">=</span> crypto<span class=\"token punctuation\">.</span><span class=\"token function\">createDecipheriv</span><span class=\"token punctuation\">(</span><span class=\"token string\">'aes-256-gcm'</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> nonce<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    decipher<span class=\"token punctuation\">.</span><span class=\"token function\">setAAD</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">)</span>\n    decipher<span class=\"token punctuation\">.</span><span class=\"token function\">setAuthTag</span><span class=\"token punctuation\">(</span>tag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    decipher<span class=\"token punctuation\">.</span><span class=\"token function\">final</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"success\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"signature\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"AES authenticator started\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> key <span class=\"token operator\">=</span> crypto<span class=\"token punctuation\">.</span><span class=\"token function\">generateKeySync</span><span class=\"token punctuation\">(</span><span class=\"token string\">'aes'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> length<span class=\"token operator\">:</span> <span class=\"token number\">256</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> failure <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"success\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"signature\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">const</span> rl <span class=\"token operator\">=</span> readline<span class=\"token punctuation\">.</span><span class=\"token function\">createInterface</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        input<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>stdin<span class=\"token punctuation\">,</span> \n        output<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>stdout<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n    rl<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'line'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">line</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">let</span> rpc <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>line<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>rpc<span class=\"token punctuation\">[</span><span class=\"token string\">'message'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">===</span> <span class=\"token keyword\">undefined</span> <span class=\"token operator\">||</span> rpc<span class=\"token punctuation\">[</span><span class=\"token string\">'message'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>length <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>failure<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>rpc<span class=\"token punctuation\">[</span><span class=\"token string\">'method'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">===</span> <span class=\"token string\">'auth'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">auth</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> rpc<span class=\"token punctuation\">[</span><span class=\"token string\">'message'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>rpc<span class=\"token punctuation\">[</span><span class=\"token string\">'signatures'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">===</span> <span class=\"token keyword\">undefined</span> <span class=\"token operator\">||</span> rpc<span class=\"token punctuation\">[</span><span class=\"token string\">'signatures'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'aes'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">===</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>failure<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n\n                console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">verify</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> rpc<span class=\"token punctuation\">[</span><span class=\"token string\">'message'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> rpc<span class=\"token punctuation\">[</span><span class=\"token string\">'signatures'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'aes'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">{</span>\n            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>failure<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h1>Solution</h1>\n<p>The challenge involves a Rust program (<code>main.rs</code>) which runs on the server. This program shells out to three other programs written in Python, Golang and NodeJS. Together, they implement some kind of auth system which you can interact with using the <code>\"backdoor\"</code>, <code>\"auth\"</code> and <code>\"verify\"</code> RPC methods. To get the flag, we must find bugs in each component of the auth system and forge valid signatures for a target message <code>FORBIDDEN</code>. The <code>\"auth\"</code> method allows us to get signatures for an arbitrary message other than the target message, and the <code>\"verify\"</code> method checks if the signatures are valid for a given message, and if the message is the target, gives us the flag. The <code>\"backdoor\"</code> method gives an oracle related to one of the authenticators (we'll get to this later).</p>\n<p>The three different authenticators use crypto functions found in their standard libraries:</p>\n<ol>\n<li>Python - <code>hmac</code></li>\n<li>Golang - <code>crypto/ecdsa</code> (<code>ecdsa.SignASN1</code>/<code>ecdsa.verifyASN1</code>)</li>\n<li>NodeJS - <code>crypto</code> module with <code>aes-256-gcm</code> cipher</li>\n</ol>\n<p>In the <code>\"auth\"</code> and <code>\"verify\"</code> method handlers, we can see that the AES authenticator depends on the ECDSA authenticator which depends on the HMAC authenticator. The message signed/verified by the HMAC authenticator is the raw message provided by us, the message signed/verified by the ECDSA authenticator is the raw message with the HMAC signature appended, and the message signed/verified by the AES authenticator is the raw message with both the HMAC and ECDSA signatures appended:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> rpc<span class=\"token punctuation\">.</span>method <span class=\"token operator\">==</span> <span class=\"token string\">\"auth\"</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token operator\">!</span>rpc<span class=\"token punctuation\">.</span>signatures<span class=\"token punctuation\">.</span><span class=\"token function\">is_none</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"{}\"</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NOPE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span> is_forbidden <span class=\"token punctuation\">{</span>\n        <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"{}\"</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NOPE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">let</span> <span class=\"token keyword\">mut</span> signature<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RPCSignature</span> <span class=\"token operator\">=</span> <span class=\"token class-name\">RPCSignature</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">..</span><span class=\"token class-name\">Default</span><span class=\"token punctuation\">::</span><span class=\"token function\">default</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">let</span> hmac_signature <span class=\"token operator\">=</span> hmac_auth<span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>rpc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">await</span><span class=\"token operator\">?</span><span class=\"token punctuation\">;</span>\n    rpc<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token keyword\">mut</span> hmac_signature<span class=\"token punctuation\">.</span><span class=\"token function\">to_vec</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// hmac signature appended</span>\n    signature<span class=\"token punctuation\">.</span>hmac <span class=\"token operator\">=</span> hmac_signature<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">let</span> ecdsa_signature <span class=\"token operator\">=</span> ecdsa_auth<span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>rpc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">await</span><span class=\"token operator\">?</span><span class=\"token punctuation\">;</span>\n    rpc<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token keyword\">mut</span> ecdsa_signature<span class=\"token punctuation\">.</span><span class=\"token function\">to_vec</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// ecdsa signature appended</span>\n    signature<span class=\"token punctuation\">.</span>ecdsa <span class=\"token operator\">=</span> ecdsa_signature<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">let</span> aes_signature <span class=\"token operator\">=</span> aes_auth<span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>rpc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">await</span><span class=\"token operator\">?</span><span class=\"token punctuation\">;</span>\n    signature<span class=\"token punctuation\">.</span>aes <span class=\"token operator\">=</span> aes_signature<span class=\"token punctuation\">;</span>\n\n    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"{}\"</span><span class=\"token punctuation\">,</span> <span class=\"token namespace\">serde_json<span class=\"token punctuation\">::</span></span><span class=\"token function\">to_string</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>signature<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Each component has a bug in the way the library is used which allows for forgery of the target message with the oracles given to us. Let's take a look at them one by one.</p>\n<h2>Python HMAC Authenticator</h2>\n<p>The bug in this component is subtle, it lies within the <code>auth</code> function which is only a single line!</p>\n<div class=\"gatsby-highlight\" data-language=\"py\"><pre class=\"language-py\"><code class=\"language-py\"><span class=\"token keyword\">def</span> <span class=\"token function\">auth</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> hmac<span class=\"token punctuation\">.</span>new<span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> sha256<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>digest<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Looking at the <a href=\"https://docs.python.org/3/library/hmac.html#hmac.new\">documentation for <code>hmac.new</code></a> the bug becomes apparent:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 600px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/67c532cb79e48c0f8dcc221cb94f50dc/64d87/docs-python-hmac.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 16.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAr0lEQVQI1z2LW2rDMBQFvf8d9KONmu6i0F0U2bryo45xiRtiQiPJxVxnAgr0Y5jzMae4TO909olBDKfe0FfPTF87vhvDIC+ch1d+j4YwGa7HXSb+7DPp9JYd8jZs8YNiXRVrHd432NLzaR1Sd9RNR1kKZSU4abDSIe2AtAcqV1M5nxvv2/zvDyOqN4ptU8ZxZJ5nliX9E2PIDuFKSom0Kotu/OmNmBIxhNw8iLlVVe72idqksaiQOQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"docs-python-hmac.png\"\n        title=\"docs-python-hmac.png\"\n        src=\"/static/67c532cb79e48c0f8dcc221cb94f50dc/0a47e/docs-python-hmac.png\"\n        srcset=\"/static/67c532cb79e48c0f8dcc221cb94f50dc/8a4e8/docs-python-hmac.png 150w,\n/static/67c532cb79e48c0f8dcc221cb94f50dc/5a46d/docs-python-hmac.png 300w,\n/static/67c532cb79e48c0f8dcc221cb94f50dc/0a47e/docs-python-hmac.png 600w,\n/static/67c532cb79e48c0f8dcc221cb94f50dc/64d87/docs-python-hmac.png 818w\"\n        sizes=\"(max-width: 600px) 100vw, 600px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>The order of the <code>msg</code> and <code>key</code> arguments are swapped.</p>\n<p>From the <a href=\"https://en.wikipedia.org/wiki/HMAC#Definition\">definition of HMAC on Wikipedia</a>, we understand that if the key is larger than the block size of the hash function (in this case 64 bytes for SHA256), then the actual key used to generate the HMAC is the hash of the key:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 600px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/73ae3af3ccee681be95295cbb5fe668c/9b379/wikipedia-hmac.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 37.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA4ElEQVQoz6VR7WrDMAz0+79j1rDFcSzZTpsvJyHkhtS5hf1pxwSHJINO8p1xziGlhL7vEULAMAxY1xXLsmjOOWPfd0ic54lXYWRwnmcla5pGUVUVZJHUkv9EWAoZOo4D27bpgt8hZO/AMBG6rgMzg0PQr/8njLUNLpcPtK1FSlGJh3HUKwXTNClKLxIViL5FstIb0cm2Hp+W4CmoQaInEd2vZgZ5j+vt9jAp53uWfv0hLb2p6xpf1qF1ESmMYGLd+BzOD9ffMkUuiDEiMCHEoHoSsV7ovYdzndbyvuTtpUHfdQBstA4gczsAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"wikipedia-hmac.png\"\n        title=\"wikipedia-hmac.png\"\n        src=\"/static/73ae3af3ccee681be95295cbb5fe668c/0a47e/wikipedia-hmac.png\"\n        srcset=\"/static/73ae3af3ccee681be95295cbb5fe668c/8a4e8/wikipedia-hmac.png 150w,\n/static/73ae3af3ccee681be95295cbb5fe668c/5a46d/wikipedia-hmac.png 300w,\n/static/73ae3af3ccee681be95295cbb5fe668c/0a47e/wikipedia-hmac.png 600w,\n/static/73ae3af3ccee681be95295cbb5fe668c/1cfc2/wikipedia-hmac.png 900w,\n/static/73ae3af3ccee681be95295cbb5fe668c/9b379/wikipedia-hmac.png 951w\"\n        sizes=\"(max-width: 600px) 100vw, 600px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>What this means is we can simply ask the <code>\"auth\"</code> oracle for the HMAC of the message <code>SHA256(FORBIDDEN)</code> and this will be a valid HMAC for the message <code>FORBIDDEN</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"py\"><pre class=\"language-py\"><code class=\"language-py\"><span class=\"token keyword\">import</span> hmac<span class=\"token punctuation\">,</span> os\n<span class=\"token keyword\">from</span> hashlib <span class=\"token keyword\">import</span> sha256\n\nkey <span class=\"token operator\">=</span> os<span class=\"token punctuation\">.</span>urandom<span class=\"token punctuation\">(</span><span class=\"token number\">32</span><span class=\"token punctuation\">)</span>\nFORBIDDEN <span class=\"token operator\">=</span> <span class=\"token string\">b'We the people, in order to get points, are kindly asking for flag'</span>\nh1 <span class=\"token operator\">=</span> hmac<span class=\"token punctuation\">.</span>new<span class=\"token punctuation\">(</span>FORBIDDEN<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> sha256<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>digest<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nh2 <span class=\"token operator\">=</span> hmac<span class=\"token punctuation\">.</span>new<span class=\"token punctuation\">(</span>sha256<span class=\"token punctuation\">(</span>FORBIDDEN<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>digest<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> sha256<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>digest<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>h1 <span class=\"token operator\">==</span> h2<span class=\"token punctuation\">)</span> <span class=\"token comment\"># True</span></code></pre></div>\n<h2>Golang ECDSA Authenticator</h2>\n<p>The bug in this component can be found by reading the <a href=\"https://pkg.go.dev/crypto/ecdsa#SignASN1\">documentation</a>/<a href=\"https://cs.opensource.google/go/go/+/refs/tags/go1.20.4:src/crypto/ecdsa/ecdsa.go;l=248\">source code</a> for the <code>ecdsa.SignASN1</code> function. The important part is the note about truncation of the <code>hash</code> argument (emphasis added):</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 600px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/50b6006a1771aaba9a39b9d93941f6f9/bc962/docs-golang-signasn1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 36%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABX0lEQVQoz0WQ63LTMBSE/SiFtqROHF/SksRxbOtiSZYvBGboDO//Ih9IKfBjZ3fP6EirTZb1G+77O8f5J/XtFydhOJ7OnOuG0/nCqW44Rr7c/QeOHyy1wTiP0gYhNUknFGqwaDti3BR1Jwcu0tAoSysUQg004v+slxo9WFplIpRxXJXl0vYk2q+MP95Z1hvzesNPC4Ob6N2M9CuD9bhxQliPGBfEuMZEfl5Qbka5CTtOyHGJYZKieuXwdiQvD2R5yb6oKKtXyupAXpRxHlCUd18UVfS7fUEedFHFnWyfs81ykqYV9FJRXzvaXlA3bcS1lwht0MbRBq2G2FcndewrfHmwI6Ey62f0YPj0+YkkHAqdBITIAb1QaGPx84qxI4NxsQrnJ5yfGf2EdT7udEIitY0PbNItSdurmPDvhYe3r7xssxg/8Ca963S3jz7dZeyynOdNytOXl3/8+Lzh4U/C37LT7yYbiEUdAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"docs-golang-signasn1.png\"\n        title=\"docs-golang-signasn1.png\"\n        src=\"/static/50b6006a1771aaba9a39b9d93941f6f9/0a47e/docs-golang-signasn1.png\"\n        srcset=\"/static/50b6006a1771aaba9a39b9d93941f6f9/8a4e8/docs-golang-signasn1.png 150w,\n/static/50b6006a1771aaba9a39b9d93941f6f9/5a46d/docs-golang-signasn1.png 300w,\n/static/50b6006a1771aaba9a39b9d93941f6f9/0a47e/docs-golang-signasn1.png 600w,\n/static/50b6006a1771aaba9a39b9d93941f6f9/bc962/docs-golang-signasn1.png 617w\"\n        sizes=\"(max-width: 600px) 100vw, 600px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>So the <code>SignASN1</code> expects the third <code>hash</code> argument to have already been hashed by the user, but in the authenticator it uses the raw message we provide which can be of any length. The hash byte array is converted to a natural number smaller than the curve order by the <a href=\"https://cs.opensource.google/go/go/+/refs/tags/go1.20.4:src/crypto/ecdsa/ecdsa.go;l=378\"><code>hashToNat</code></a> function. All this function does is truncate the bits/bytes of the <code>hash</code> so that it is less than the size of the curve order. The curve order is 521 bits, so anything beyond the 521st bit is ignored.</p>\n<p>What this means is we can simply ask the <code>\"auth\"</code> oracle for the ECDSA signature of the message <code>FORBIDDEN + X</code> where <code>X</code> is any non-empty prefix of <code>HMAC(FORBIDDEN)</code>, and this will be a valid ECDSA signature for the message <code>FORBIDDEN + HMAC(FORBIDDEN)</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">package</span> main\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"crypto/ecdsa\"</span>\n    <span class=\"token string\">\"crypto/elliptic\"</span>\n    <span class=\"token string\">\"crypto/rand\"</span>\n    <span class=\"token string\">\"fmt\"</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    privateKey<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> ecdsa<span class=\"token punctuation\">.</span><span class=\"token function\">GenerateKey</span><span class=\"token punctuation\">(</span>elliptic<span class=\"token punctuation\">.</span><span class=\"token function\">P521</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> rand<span class=\"token punctuation\">.</span>Reader<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">panic</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">var</span> msg <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token function\">byte</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"We the people, in order to get points, are kindly asking for flagXXX\"</span><span class=\"token punctuation\">)</span>\n    signature<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> ecdsa<span class=\"token punctuation\">.</span><span class=\"token function\">SignASN1</span><span class=\"token punctuation\">(</span>rand<span class=\"token punctuation\">.</span>Reader<span class=\"token punctuation\">,</span> privateKey<span class=\"token punctuation\">,</span> msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">panic</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">var</span> msg2 <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token function\">byte</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"We the people, in order to get points, are kindly asking for flagXYY\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> ecdsa<span class=\"token punctuation\">.</span><span class=\"token function\">VerifyASN1</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>privateKey<span class=\"token punctuation\">.</span>PublicKey<span class=\"token punctuation\">,</span> msg2<span class=\"token punctuation\">,</span> signature<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"success!\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n# success<span class=\"token operator\">!</span></code></pre></div>\n<h2>NodeJS AES Authenticator</h2>\n<p>The last step is the AES authenticator. Fortunately, we have a <code>\"backdoor\"</code> which gives us the first 15 bytes of output from a call to the authenticator with any input message. Since the first 12 bytes are for the nonce, this means we get the first 3 bytes of the 12 byte authentication tag. Reading the <a href=\"https://nodejs.org/api/crypto.html#cryptocreatedecipherivalgorithm-key-iv-options\">documentation</a> and <a href=\"https://github.com/nodejs/node/blob/4bb06dbd0a87e5b2430780ddceec08015f8c496a/src/crypto/crypto_cipher.cc\">source</a> for the used functions again helps to point out the bug in its usage (emphasis added):</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 600px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/637d35d8c44bd76eeeeaa64d38d614ec/cab43/docs-nodejs-create-decipheriv.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 61.33333333333334%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAACOklEQVQoz21TaW/aQBC1VHEbfGF7d33g247BYJyASSAtiRIiJZX6/3/Nq3ZN1Kbqh6d5c8/O7kr70zPOl3c8nF9xfn3H+fKB8+Unjk+veHn/JfTH5zccny54OL90cVebbnrojwyMZBODsQHVcCGZJMRUIfjWV9Ab6ugNdPRHOgYjQ8hP8AQBYe/kcDIXxUZyJ7kuzTSGMKuwiJdQTQezOcF4al0D/8HkK+cF/ga3S7rp42ZzBxbGmDsedOpAIwyKSaEYFKpFMdOJkBxTzk0m+KdfsxlklXQFZYVgzjyohECZU4ynJmTVEpJjolgYzyxMdRtTzYas2h3XOy5rtvB/Ti4Z9gJpWYMuIhjMFXCLBDSO4WQpaBzCoK6YWrXYdao/fGaQL2uRFN3Bqm7hBBk02h1BtR1o1IPu+FAsholqiovoDTT0hpq4vP7wPxc2NiDZLAZ1EhAWwXYiLJISXljAphFMK4Bph7BoBOLE8ONSwAlyEDcBvcKiodBNGkDiwW5QiIS5FYB6KdwgB29k8yYsAn9aHM4iA/NTMD8TTXghLk0SiHxFZ5DibI1lvceqaVHfPaDc7BEmKyT5BtyX5GvB17f3aNoTVvUeSbYWvmJ5iyitkBY10nwDvj6JG4uyESirHaq6RV42yG62ImiRFAjyAnlVY7s7odmdUG1a7O5/4PT0Jn7Mbfsdm+0BflBAqpoDmvYR1faAdXMQxTjf7o6od0cxBbcVy0ZMmt9s4fqZOCIH81IwLxO75E/wN5pFQnC5C3s4AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"docs-nodejs-create-decipheriv\"\n        title=\"docs-nodejs-create-decipheriv\"\n        src=\"/static/637d35d8c44bd76eeeeaa64d38d614ec/0a47e/docs-nodejs-create-decipheriv.png\"\n        srcset=\"/static/637d35d8c44bd76eeeeaa64d38d614ec/8a4e8/docs-nodejs-create-decipheriv.png 150w,\n/static/637d35d8c44bd76eeeeaa64d38d614ec/5a46d/docs-nodejs-create-decipheriv.png 300w,\n/static/637d35d8c44bd76eeeeaa64d38d614ec/0a47e/docs-nodejs-create-decipheriv.png 600w,\n/static/637d35d8c44bd76eeeeaa64d38d614ec/cab43/docs-nodejs-create-decipheriv.png 755w\"\n        sizes=\"(max-width: 600px) 100vw, 600px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Looking through the <a href=\"https://github.com/nodejs/node/blob/4bb06dbd0a87e5b2430780ddceec08015f8c496a/src/crypto/crypto_cipher.cc#L49-L51\">source code</a>, we see that if the <code>authTagLength</code> option is not explicitly specified, then any valid auth tag length will work:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">bool <span class=\"token function\">IsValidGCMTagLength</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">unsigned int tag_len</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> tag_len <span class=\"token operator\">==</span> <span class=\"token number\">4</span> <span class=\"token operator\">||</span> tag_len <span class=\"token operator\">==</span> <span class=\"token number\">8</span> <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>tag_len <span class=\"token operator\">>=</span> <span class=\"token number\">12</span> <span class=\"token operator\">&amp;&amp;</span> tag_len <span class=\"token operator\">&lt;=</span> <span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>A tag length of 4 is valid, and we can get the first 3 bytes of the actual tag. So we can just bruteforce the last byte to get a valid tag.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> crypto <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'crypto'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> key <span class=\"token operator\">=</span> Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> msg <span class=\"token operator\">=</span> Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> nonce <span class=\"token operator\">=</span> Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> cipher <span class=\"token operator\">=</span> crypto<span class=\"token punctuation\">.</span><span class=\"token function\">createCipheriv</span><span class=\"token punctuation\">(</span><span class=\"token string\">'aes-256-gcm'</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> nonce<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\ncipher<span class=\"token punctuation\">.</span><span class=\"token function\">setAAD</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\ncipher<span class=\"token punctuation\">.</span><span class=\"token function\">final</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> tag <span class=\"token operator\">=</span> cipher<span class=\"token punctuation\">.</span><span class=\"token function\">getAuthTag</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> decipher <span class=\"token operator\">=</span> crypto<span class=\"token punctuation\">.</span><span class=\"token function\">createDecipheriv</span><span class=\"token punctuation\">(</span><span class=\"token string\">'aes-256-gcm'</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> nonce<span class=\"token punctuation\">)</span>\ndecipher<span class=\"token punctuation\">.</span><span class=\"token function\">setAAD</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">)</span>\ndecipher<span class=\"token punctuation\">.</span><span class=\"token function\">setAuthTag</span><span class=\"token punctuation\">(</span>tag<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\ndecipher<span class=\"token punctuation\">.</span><span class=\"token function\">final</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// no error</span></code></pre></div>\n<h1>Solve Script</h1>\n<div class=\"gatsby-highlight\" data-language=\"py\"><pre class=\"language-py\"><code class=\"language-py\"><span class=\"token keyword\">from</span> pwn <span class=\"token keyword\">import</span> <span class=\"token operator\">*</span>\n<span class=\"token keyword\">from</span> hashlib <span class=\"token keyword\">import</span> sha256\n<span class=\"token keyword\">from</span> base64 <span class=\"token keyword\">import</span> b64encode<span class=\"token punctuation\">,</span> b64decode\n<span class=\"token keyword\">import</span> json<span class=\"token punctuation\">,</span> hmac\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">rpc_auth</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    rpc <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token string\">'method'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'auth'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'message'</span><span class=\"token punctuation\">:</span> b64encode<span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span>\n    conn<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">.</span>dumps<span class=\"token punctuation\">(</span>rpc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>encode<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> json<span class=\"token punctuation\">.</span>loads<span class=\"token punctuation\">(</span>conn<span class=\"token punctuation\">.</span>recvline<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">rpc_verify</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">,</span> signatures<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    rpc <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token string\">'method'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'verify'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'message'</span><span class=\"token punctuation\">:</span> b64encode<span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'signatures'</span><span class=\"token punctuation\">:</span> signatures<span class=\"token punctuation\">}</span>\n    conn<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">.</span>dumps<span class=\"token punctuation\">(</span>rpc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>encode<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> conn<span class=\"token punctuation\">.</span>recvline<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">rpc_backdoor</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    rpc <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token string\">'method'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'backdoor'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'message'</span><span class=\"token punctuation\">:</span> b64encode<span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span>\n    conn<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">.</span>dumps<span class=\"token punctuation\">(</span>rpc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>encode<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> conn<span class=\"token punctuation\">.</span>recv<span class=\"token punctuation\">(</span><span class=\"token number\">15</span><span class=\"token punctuation\">)</span>\n\nFORBIDDEN <span class=\"token operator\">=</span> <span class=\"token string\">b'We the people, in order to get points, are kindly asking for flag'</span>\n\nconn <span class=\"token operator\">=</span> remote<span class=\"token punctuation\">(</span><span class=\"token string\">'multiauth.nc.jctf.pro'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1337</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>conn<span class=\"token punctuation\">.</span>recvline<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># solve hmac by just asking for auth of H(FORBIDDEN)</span>\nhmac_auth <span class=\"token operator\">=</span> rpc_auth<span class=\"token punctuation\">(</span>sha256<span class=\"token punctuation\">(</span>FORBIDDEN<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>digest<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># solve ecdsa with len >65 message suffixed with the hmac</span>\necdsa_auth <span class=\"token operator\">=</span> rpc_auth<span class=\"token punctuation\">(</span>FORBIDDEN <span class=\"token operator\">+</span> b64decode<span class=\"token punctuation\">(</span>hmac_auth<span class=\"token punctuation\">[</span><span class=\"token string\">'hmac'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># solve aes with tag length of 4 and bruteforce last byte of tag</span>\nA <span class=\"token operator\">=</span> FORBIDDEN <span class=\"token operator\">+</span> b64decode<span class=\"token punctuation\">(</span>hmac_auth<span class=\"token punctuation\">[</span><span class=\"token string\">'hmac'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> b64decode<span class=\"token punctuation\">(</span>ecdsa_auth<span class=\"token punctuation\">[</span><span class=\"token string\">'ecdsa'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\naes_auth_base <span class=\"token operator\">=</span> rpc_backdoor<span class=\"token punctuation\">(</span>A<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">for</span> b <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">256</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    aes_auth <span class=\"token operator\">=</span> aes_auth_base <span class=\"token operator\">+</span> <span class=\"token builtin\">bytes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>b<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    sigs <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token string\">'ecdsa'</span><span class=\"token punctuation\">:</span> ecdsa_auth<span class=\"token punctuation\">[</span><span class=\"token string\">'ecdsa'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'hmac'</span><span class=\"token punctuation\">:</span> hmac_auth<span class=\"token punctuation\">[</span><span class=\"token string\">'hmac'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'aes'</span><span class=\"token punctuation\">:</span> b64encode<span class=\"token punctuation\">(</span>aes_auth<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">,</span> rpc_verify<span class=\"token punctuation\">(</span>FORBIDDEN<span class=\"token punctuation\">,</span> sigs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># justCTF{br34k1ngAP1sLikeAPr0}</span></code></pre></div>","frontmatter":{"date":"June 05, 2023","path":"/posts/2023-06-05-justctf-2023-multi-auth-writeup","title":"justCTF 2023 - Multi Auth","tags":"ctf,writeup,crypto"}}},"pageContext":{"prev":{"fileAbsolutePath":"/media/winarch-shared/code/portfolio/src/posts/2023-04-30-angstromctf-2023-tau-as-a-service-writeup/index.md","frontmatter":{"title":"ngstromCTF 2023 - tau as a service","date":"2023-04-30T00:00:00.000Z","path":"/posts/2023-04-30-angstromctf-2023-tau-as-a-service-writeup"}},"next":null}},
    "staticQueryHashes": ["4146750380"]}